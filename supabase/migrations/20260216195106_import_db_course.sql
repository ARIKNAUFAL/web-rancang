-- Converted from MySQL dump (db_course.sql) to PostgreSQL for Supabase

begin;

-- Clean existing objects
DROP VIEW IF EXISTS request_manager CASCADE;
DROP VIEW IF EXISTS inserted_lesson CASCADE;
DROP VIEW IF EXISTS detailed_admin CASCADE;

DROP TABLE IF EXISTS notification CASCADE;
DROP TABLE IF EXISTS "class" CASCADE;
DROP TABLE IF EXISTS feedback CASCADE;
DROP TABLE IF EXISTS course_suggestion CASCADE;
DROP TABLE IF EXISTS roadmap CASCADE;
DROP TABLE IF EXISTS lesson_audit CASCADE;
DROP TABLE IF EXISTS lesson CASCADE;
DROP TABLE IF EXISTS profile_student CASCADE;
DROP TABLE IF EXISTS profile_admin CASCADE;
DROP TABLE IF EXISTS student CASCADE;
DROP TABLE IF EXISTS category CASCADE;
DROP TABLE IF EXISTS admin CASCADE;

CREATE TABLE admin (
  id char(5) PRIMARY KEY,
  username varchar(20) NOT NULL UNIQUE,
  password text NOT NULL,
  email varchar(40) NOT NULL UNIQUE,
  status text DEFAULT 'Active' CHECK (status IN ('Active','Non-active'))
);

CREATE TABLE category (
  id char(5) PRIMARY KEY,
  name varchar(100) UNIQUE
);

CREATE TABLE student (
  id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  username varchar(20) NOT NULL UNIQUE,
  password varchar(255) NOT NULL,
  email varchar(40) NOT NULL UNIQUE,
  status text DEFAULT 'Active' CHECK (status IN ('Active','Non-active'))
);

CREATE TABLE profile_admin (
  admin_id char(5) PRIMARY KEY,
  first_name varchar(15),
  last_name varchar(15),
  address varchar(30),
  phone_number varchar(13),
  gender text DEFAULT 'Male' CHECK (gender IN ('Male','Female')),
  photo_profile varchar(20)
);

CREATE TABLE profile_student (
  student_id integer PRIMARY KEY,
  first_name varchar(15) NOT NULL,
  last_name varchar(15) NOT NULL,
  address varchar(30) NOT NULL,
  phone_number varchar(13) NOT NULL,
  gender text NOT NULL DEFAULT 'Male' CHECK (gender IN ('Male','Female')),
  photo_profile varchar(255) DEFAULT 'templateFrontend/resources/images/Default-Profile.png'
);

CREATE TABLE lesson (
  id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  admin_id char(5) NOT NULL,
  category_id char(5),
  name varchar(100) NOT NULL,
  thumbnail varchar(255) NOT NULL,
  description text,
  link varchar(200) NOT NULL UNIQUE
);

CREATE TABLE course_suggestion (
  id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  student_id integer NOT NULL,
  admin_id char(5),
  topic varchar(100) NOT NULL,
  message varchar(200) NOT NULL,
  status text NOT NULL DEFAULT 'New' CHECK (status IN ('New','Responded','Declined')),
  date date NOT NULL DEFAULT current_date
);

CREATE TABLE feedback (
  id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  lesson_id integer NOT NULL,
  student_id integer NOT NULL,
  comment varchar(10000) NOT NULL,
  date_comment timestamp NOT NULL DEFAULT current_timestamp
);

CREATE TABLE lesson_audit (
  id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  admin_id char(5) NOT NULL,
  audit_action varchar(106) NOT NULL,
  date date NOT NULL DEFAULT current_date
);

CREATE TABLE roadmap (
  id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  category_id char(5) NOT NULL,
  lesson_id integer
);

CREATE TABLE "class" (
  id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  student_id integer NOT NULL,
  lesson_id integer NOT NULL,
  enroll_date date NOT NULL DEFAULT current_date
);

CREATE TABLE notification (
  course_suggestion_id integer PRIMARY KEY,
  message varchar(232) NOT NULL,
  date date NOT NULL DEFAULT current_date,
  link varchar(200) UNIQUE
);

CREATE INDEX idx_lesson_name ON lesson(name);
CREATE INDEX idx_lesson_audit_action ON lesson_audit(audit_action);

INSERT INTO "admin" ("id", "username", "password", "email", "status") VALUES
('A0001', 'ivan', '$2y$10$gyjAVWYp0E6kfuEdV.dEw.g6AM9HtEBEPmX/R7PerENRlbQ.bjA0e', 'ivan@gmail.com', 'Active'),
('A0002', 'arik', '$2y$10$ssjQ7qiW6jWW3vtH6gl.uu2ab5xO/MW35h9lYdfAb2RvyomM1uMwe', 'arik@gmail.com', 'Active'),
('A0003', 'jono', '$2y$10$Y0u29Y.CZKOz2M/b3T4/EODi1P72wpjA.2K78XPh/yszaiMhB7qVe', 'jono@gmail.com', 'Active'),
('A0004', 'renaldi', '$2y$10$7fpc1x8h/GNKNUj8wyWfaeQve.sLi8JjoYtmzXb/1leOvBzNHJAxe', 'renaldi@gmail.com', 'Non-active'),
('A0005', 'renaldi1', '$2y$10$33nvGOddtFxbzT/nTcC2ueClsaKfC/ZAIII46USLDO579Syb0GjVK', 'renaldi1@gmail.com', 'Active'),
('A0006', 'zidan', '$2y$10$N/HZjYvqwYPNVi2AS5XlfeNh1p9Qcru6cjb4odFJ9g.Dfeu6L/MdC', 'zidan@gmail.com', 'Active'),
('A0007', 'yasmin', '$2y$10$w0.XQ1eEodS3N2E8szQtouwS/3tlHj74Tbf1ybVWE4UY4zLv/2xq2', 'yasmin@gmail.com', 'Non-active'),
('A0008', 'kira', '$2y$10$xlXFkmgWzhzrvsjRI1FjfO5y86wpeoOCdsIUWH7jBiJsRkyi5e1qa', 'ariknaufal2003@gmail.com', 'Active');

INSERT INTO "category" ("id", "name") VALUES
('C0003', 'Back-end'),
('C0007', 'Figma'),
('C0002', 'Front-end'),
('C0001', 'Full-stack developer'),
('C0004', 'Java'),
('C0005', 'JavaScript'),
('C0006', 'PHP');

INSERT INTO "student" ("id", "username", "password", "email", "status") VALUES
(1, 'raniya', '$2y$10$mFcgyGl7sT.yNJFls0s43uFx4uIBdctV0HLlMjTV72mTaJzDcVipy', 'raniya@gmail.com', 'Active'),
(2, 'yudha', '$2y$10$8N04Qir5GaUkjwUBlfhkOukhwQKUUTAcQNiA5bw2QG8BBRf6hLW4K', 'yudha@gmail.com', 'Active'),
(3, 'jamal', '$2y$10$3DrGx5PUNzSTG0aC7fbYIe33vCwbLff3K3XcS/5RVQPewkEIVIEDm', 'jamal@gmail.com', 'Active'),
(7, 'ariknaufal', '$2y$10$SVemzsm7mhpL3rxklbqcfuNaW0u74vRI9TraepZD1zKMcG03j8r8y', 'ariknaufal2003@gmail.com', 'Active');

INSERT INTO "profile_admin" ("admin_id", "first_name", "last_name", "address", "phone_number", "gender", "photo_profile") VALUES
('A0001', 'M. Ivan', 'Ra''is', 'JL TANGERANG NO.18', '323902482', 'Male', 'ivan-photo.jpg'),
('A0002', 'Arik', 'Naufal', 'JL BEKASI NO.18', '31253125', 'Male', 'arik-photo.jpg'),
('A0003', 'jono', '', '', NULL, 'Male', ''),
('A0004', 'renaldi', '', '', '', 'Male', ''),
('A0005', 'renaldinasa', 'adama', 'Bekasi', '089898787', 'Male', '01202023024634.jpg'),
('A0006', 'zidan', 'muhammad', 'jakarta', '082142314409', 'Male', '01162023012347.png'),
('A0007', 'yasmin', '', '', '', 'Male', ''),
('A0008', 'anselma', 'putri', 'Jl Jagakarsa', '087545329087', 'Female', '01162023025030.jpg');

INSERT INTO "profile_student" ("student_id", "first_name", "last_name", "address", "phone_number", "gender", "photo_profile") VALUES
(1, 'Raniya', 'Maryam', 'Jl. Random', '23456789', 'Female', 'raniya-photo.png'),
(2, 'Yudha', 'Ardhana', 'Jl. Nusa Indah', '34567890', 'Male', 'templateFrontend/resources/images/Default-Profile.png	'),
(3, 'jamal', '', '', '', 'Male', 'templateFrontend/resources/images/Default-Profile.png	'),
(7, 'habib', 'riziq', 'bekasi', '082142314409', 'Male', 'images/profiles\\r6hzeBX2Sdgp1cB9cZv5tp0zEO4jc8zr1lptsFTV.jpg');

INSERT INTO "lesson" ("id", "admin_id", "category_id", "name", "thumbnail", "description", "link") VALUES
(1, 'A0005', 'C0002', 'Learn HTML - Full Tutorial for Beginners', 'images/lessons/Z47mlCbEjocxecPlMDvwY73DM7sJvYMBqfg6Ndfa.png', 'Learn HTML in this complete course for beginners. This is an all-in-one beginner tutorial to help you learn web development skills. This course teaches HTML5.', 'https://www.youtube.com/watch?v=kUMe1FH4CHE'),
(2, 'A0008', 'C0002', 'JavaScript DOM', 'images/lessons/C3Q0e32h12B4UjbvtRPY3ByX3hWtzECF0ELSgfQc.png', 'Hey gang, welcome to your very first JavaScript DOM tutorial. In this tutorial Ill explain exactly what the DOM is (document object model) and how we can use it in JavaScript to interact with web pages in the browser.', 'https://www.youtube.com/watch?v=FIORjGvT0kk&list=PL4cUxeGkcC9gfoKa5la9dsdCNpuey2s-V'),
(5, 'A0008', 'C0003', 'Basic Golang', 'images/lessons\\GW1YUk7wvfwvjOQZpkfZmPd55UQbarORHNWpQg9U.png', 'Learn basic golang', 'https://www.youtube.com/watch?v=YS4e4q9oBaU'),
(7, 'A0005', 'C0003', 'Python', 'images/lessons\\NO5ck3gkNsnylazn8F3taQ4lpvXb9b7MCDX44Rjp.jpg', 'https://www.youtube.com/watch?v=kqtD5dpn9C8', 'https://www.youtube.com/watch?v=kqtD5dpn9C8'),
(8, 'A0008', 'C0003', 'Ruby', 'images/lessons\\TVYmjokdVblu79TYarsBZTRVQROrwFf6KtdlZo1S.jpg', 'Ruby in 100 Seconds', 'https://www.youtube.com/watch?v=UYm0kfnRTJk'),
(9, 'A0008', 'C0003', 'Database Management Systems', 'images/lessons\\NGCh69Nsu5tabvZ8uGKVxyiQ11YLtOhbQ479Y3G9.png', 'Introduction To Database Management', 'https://www.youtube.com/watch?v=ztHopE5Wnpc'),
(10, 'A0008', 'C0002', 'Git & Github', 'images/lessons\\Ljm7oR9jPWvI7w29mGZUqvOWqlJ2eD5a4q2tYvrT.png', 'Learn Git&Hub Tools', 'https://www.youtube.com/watch?v=RGOj5yH7evk'),
(11, 'A0008', 'C0002', 'CSS Tutorial For Beginners', 'images/lessons\\8SH7l5rhO0lPZaoujNK1RfSG5QsR5VtO6RmRvT4x.png', 'In this in-depth course, you will learn about all the key features of CSS. This is the most comprehensive CSS course we''ve published to date. So if you want to become an expert in Cascading Style Sheets, this is the course for you.', 'https://www.youtube.com/watch?v=OXGznpKZ_sA'),
(12, 'A0008', 'C0002', 'JavaScript Tutorial For Beginners', 'images/lessons\\LZBPGkTtLR2xR7j4HScgB0nMVi0SirRc4xetZmbq.png', 'This complete 134-part JavaScript tutorial for beginners will teach you everything you need to know to get started with the JavaScript programming language.', 'https://www.youtube.com/watch?v=PkZNo7MFNFg'),
(13, 'A0008', 'C0002', 'JavaScript DOM', 'images/lessons\\3aVWxH1r998Bm3iWmwMQdepHmriLoyZvZk9hjxiE.jpg', 'Learn about JavaScript DOM manipulation in this beginner''s tutorial. This is when you use JavaScript to add, remove, and modify elements of a website. \r\n\r\nIn the first part of the course, you will learn about the basic features of a website DOM and the JavaScript commands you can use to manipulate the DOM. In the second part of the course, you will use what you have learned to create practical examples ranging from beginner to advanced.', 'https://youtu.be/5fb2aPlgoys'),
(14, 'A0008', 'C0006', 'PHP For Beginnners', 'images/lessons\\FF9NiGqXTrW3ar9i5W0iLQhGTwhg3tRpN32zGbzN.png', 'Your first step in learning PHP. We will go over all of the fundamentals and create a small PHP/MySQL project.', 'https://www.youtube.com/watch?v=BUCiSSyIGGU'),
(15, 'A0008', 'C0006', 'PHP OOP', 'images/lessons\\usrw6T7pDaOTETzm4dmUS8EAHSATKw6SK0trUwTn.png', 'Setelah belajar PHP Dasar, saatnya kita belajar PHP Object Oriented Programming (PHP Pemrograman Berorientasi Objek). OOP adalah sudut pandang dalam bahasa pemrograman yang sangat populer. OOP wajib dimengerti jika kita ingin lebih baik lagi menjadi programmer PHP, terutama saat ini kebanyakan library dan framework di PHP sudah menggunakan OOP', 'https://www.youtube.com/watch?v=_P2t0lCzU-Q'),
(16, 'A0008', 'C0001', 'MySQL - Database', 'images/lessons\\qv3Ss7ScnViYz5EW7iLpXAnHLk8NhqS26uhQloIQ.jpg', 'Di video kali ini, saya akan bahas tentang belajar database MySQL, salah satu database relational yang paling populer di dunia. Di video ini kita akan banyak belajar tentang perintah SQL di MySQL dari pembuatan database, table dan manipulasi data di MySQL. Tak lupa kita juga akan belajar tentang relational, foreign key, join table, dan lain-lain.', 'https://www.youtube.com/watch?v=xYBclb-sYQ4'),
(17, 'A0008', 'C0004', 'Java Full Course', 'images/lessons\\p1SbIWHvzOnSYGzt4y2sWI9P20VkXdUE92i3d6Ae.png', 'Java Full Course', 'https://www.youtube.com/watch?v=xk4_1vDrzzo'),
(18, 'A0008', 'C0001', 'Browser Developer Tools', 'images/lessons\\x37jrtpjs5QLpXQ6K5Pdq5kUH6WQyLGifWiF63jV.jpg', 'Demystifying the Browser Networking Tab in Developer Tools With Examples', 'https://www.youtube.com/watch?v=LBgfSwX4GDI'),
(19, 'A0008', 'C0001', 'Testing/Debugging', 'images/lessons\\4L0qxw70NDy6OeFfAxeBXSWxVk6HMsYGRGGwUQMm.png', 'What is Testing | What is Debugging | Testing in Nutshell | Neeraj Kumar Singh', 'https://www.youtube.com/watch?v=BW2TtfcK-1A'),
(20, 'A0008', 'C0001', 'Command Line', 'images/lessons\\Nq7ZKN7u3Jrm2KSk8OYj6rh5gfjY4TZKiihhjaDe.png', '40 Windows Commands you NEED to know (in 10 Minutes)', 'https://www.youtube.com/watch?v=Jfvg3CS1X3A'),
(21, 'A0008', 'C0003', 'Figma', 'images/lessons\\DoRU8AYa3UP9IZytG3qDfjN9JCKuRdATpMqfFort.png', 'Figma UI Design Tutorial: Get Started (2022)', 'https://www.youtube.com/watch?v=NA7LoY23MlA');

INSERT INTO "course_suggestion" ("id", "student_id", "admin_id", "topic", "message", "status", "date") VALUES
(7, 7, 'A0008', 'Figma', 'want to learn about design app', 'Responded', '2023-01-24'),
(8, 7, 'A0008', 'Data Structure', 'pengen', 'Declined', '2023-01-24'),
(9, 7, NULL, 'ReactJS', 'INGIN BELALAR', 'New', '2023-01-24');

INSERT INTO "feedback" ("id", "lesson_id", "student_id", "comment", "date_comment") VALUES
(5, 1, 7, 'bagus', '2023-01-24 01:25:38'),
(6, 1, 7, 'video nya keren', '2023-01-24 04:57:49'),
(7, 5, 7, 'k', '2023-01-26 01:41:58'),
(8, 5, 7, 'k', '2023-01-26 01:42:01'),
(9, 5, 7, 'k', '2023-01-26 01:42:03');

INSERT INTO "lesson_audit" ("id", "admin_id", "audit_action", "date") VALUES
(1, 'A0001', 'Insert: Learn HTML - Full Tutorial for Beginners', '2023-01-07'),
(8, 'A0005', 'Insert : ReactJS category', '2023-01-20'),
(9, 'A0005', 'Update : from ReactJS to JEST category', '2023-01-20'),
(10, 'A0005', 'Insert: Intro to Laravel', '2023-01-23'),
(11, 'A0005', 'Update: Intro to Laravel2', '2023-01-23'),
(12, 'A0005', 'Update: Intro to Laravel2', '2023-01-23'),
(13, 'A0005', 'Update: Intro to Laravel2', '2023-01-23'),
(14, 'A0005', 'Update: Intro to Laravel2', '2023-01-23'),
(15, 'A0005', 'Insert : lara category', '2023-01-23'),
(16, 'A0005', 'Update : from lara to lara2 category', '2023-01-23'),
(17, 'A0005', 'Update: Learn HTML - Full Tutorial for Beginners', '2023-01-23'),
(18, 'A0005', 'Update: JavaScript DOM', '2023-01-23'),
(19, 'A0005', 'Insert: Basic Golang', '2023-01-23'),
(20, 'A0005', 'Insert: Symfony Basic', '2023-01-23'),
(21, 'A0005', 'Update: Symfony Advanced', '2023-01-23'),
(22, 'A0005', 'Update: Symfony Advanced', '2023-01-23'),
(23, 'A0005', 'Update: Basic Golang', '2023-01-24'),
(24, 'A0005', 'Insert: Python', '2023-01-24'),
(25, 'A0008', 'Insert: Ruby', '2023-01-24'),
(26, 'A0008', 'Insert: Database Management Systems', '2023-01-24'),
(27, 'A0008', 'Insert: Git & Github', '2023-01-24'),
(28, 'A0008', 'Insert: CSS Tutorial For Beginners', '2023-01-24'),
(29, 'A0008', 'Insert: JavaScript Tutorial For Beginners', '2023-01-24'),
(30, 'A0008', 'Insert: JavaScript DOM', '2023-01-24'),
(31, 'A0008', 'Update: JavaScript DOM', '2023-01-24'),
(32, 'A0008', 'Insert: PHP For Beginnners', '2023-01-24'),
(33, 'A0008', 'Insert: PHP OOP', '2023-01-24'),
(34, 'A0008', 'Insert: MySQL - Database', '2023-01-24'),
(35, 'A0008', 'Insert: Java Full Course', '2023-01-24'),
(36, 'A0008', 'Update: Ruby', '2023-01-24'),
(37, 'A0008', 'Update: Basic Golang', '2023-01-24'),
(38, 'A0008', 'Insert: Browser Developer Tools', '2023-01-24'),
(39, 'A0008', 'Insert: Testing/Debugging', '2023-01-24'),
(40, 'A0008', 'Update: Testing/Debugging', '2023-01-24'),
(41, 'A0008', 'Insert: Command Line', '2023-01-24'),
(42, 'A0008', 'Update: MySQL - Database', '2023-01-24'),
(43, 'A0008', 'Insert: Figma', '2023-01-24'),
(44, 'A0008', 'Insert : Figma category', '2023-01-24');

INSERT INTO "roadmap" ("id", "category_id", "lesson_id") VALUES
(1, 'C0002', 1),
(2, 'C0002', 2),
(3, 'C0003', 5),
(5, 'C0003', 7),
(6, 'C0003', 8),
(7, 'C0003', 9),
(8, 'C0002', 10),
(9, 'C0002', 11),
(10, 'C0002', 12),
(11, 'C0002', 13),
(12, 'C0006', 14),
(13, 'C0006', 15),
(14, 'C0001', 16),
(15, 'C0004', 17),
(16, 'C0001', 18),
(17, 'C0001', 19),
(18, 'C0001', 20),
(19, 'C0003', 21);

INSERT INTO "class" ("id", "student_id", "lesson_id", "enroll_date") VALUES
(3, 7, 5, '2023-01-24'),
(4, 7, 1, '2023-01-24');

-- Foreign keys
ALTER TABLE lesson
  ADD CONSTRAINT fk_lesson_admin FOREIGN KEY (admin_id) REFERENCES admin(id),
  ADD CONSTRAINT fk_lesson_category FOREIGN KEY (category_id) REFERENCES category(id) ON DELETE SET NULL;

ALTER TABLE profile_admin
  ADD CONSTRAINT fk_profile_admin_admin FOREIGN KEY (admin_id) REFERENCES admin(id) ON DELETE CASCADE;

ALTER TABLE profile_student
  ADD CONSTRAINT fk_profile_student_student FOREIGN KEY (student_id) REFERENCES student(id) ON DELETE CASCADE;

ALTER TABLE course_suggestion
  ADD CONSTRAINT fk_course_suggestion_admin FOREIGN KEY (admin_id) REFERENCES admin(id) ON DELETE SET NULL,
  ADD CONSTRAINT fk_course_suggestion_student FOREIGN KEY (student_id) REFERENCES student(id) ON DELETE CASCADE;

ALTER TABLE feedback
  ADD CONSTRAINT fk_feedback_lesson FOREIGN KEY (lesson_id) REFERENCES lesson(id) ON DELETE CASCADE,
  ADD CONSTRAINT fk_feedback_student FOREIGN KEY (student_id) REFERENCES student(id) ON DELETE CASCADE;

ALTER TABLE lesson_audit
  ADD CONSTRAINT fk_lesson_audit_admin FOREIGN KEY (admin_id) REFERENCES admin(id);

ALTER TABLE roadmap
  ADD CONSTRAINT fk_roadmap_category FOREIGN KEY (category_id) REFERENCES category(id) ON DELETE CASCADE,
  ADD CONSTRAINT fk_roadmap_lesson FOREIGN KEY (lesson_id) REFERENCES lesson(id) ON DELETE CASCADE;

ALTER TABLE "class"
  ADD CONSTRAINT fk_class_lesson FOREIGN KEY (lesson_id) REFERENCES lesson(id) ON DELETE CASCADE,
  ADD CONSTRAINT fk_class_student FOREIGN KEY (student_id) REFERENCES student(id) ON DELETE CASCADE;

ALTER TABLE notification
  ADD CONSTRAINT fk_notification_course_suggestion FOREIGN KEY (course_suggestion_id) REFERENCES course_suggestion(id);

-- Align identity sequences to imported IDs
SELECT setval(pg_get_serial_sequence('student','id'), COALESCE((SELECT MAX(id) FROM student), 1), true);
SELECT setval(pg_get_serial_sequence('lesson','id'), COALESCE((SELECT MAX(id) FROM lesson), 1), true);
SELECT setval(pg_get_serial_sequence('course_suggestion','id'), COALESCE((SELECT MAX(id) FROM course_suggestion), 1), true);
SELECT setval(pg_get_serial_sequence('feedback','id'), COALESCE((SELECT MAX(id) FROM feedback), 1), true);
SELECT setval(pg_get_serial_sequence('lesson_audit','id'), COALESCE((SELECT MAX(id) FROM lesson_audit), 1), true);
SELECT setval(pg_get_serial_sequence('roadmap','id'), COALESCE((SELECT MAX(id) FROM roadmap), 1), true);
SELECT setval(pg_get_serial_sequence('"class"','id'), COALESCE((SELECT MAX(id) FROM "class"), 1), true);

-- Views
CREATE OR REPLACE VIEW detailed_admin AS
SELECT concat(pa.first_name, ' ', pa.last_name) AS "Fullname",
       pa.phone_number AS "Phone Number",
       a.email AS "Email",
       a.status AS "Status"
FROM admin a
JOIN profile_admin pa ON pa.admin_id = a.id;

CREATE OR REPLACE VIEW inserted_lesson AS
SELECT l.name AS "Lesson Name",
       c.name AS "Category",
       concat(pa.first_name, ' ', pa.last_name) AS "Inserted By"
FROM admin a
JOIN profile_admin pa ON pa.admin_id = a.id
JOIN lesson l ON l.admin_id = a.id
JOIN roadmap r ON r.lesson_id = l.id
JOIN category c ON c.id = r.category_id;

CREATE OR REPLACE VIEW request_manager AS
SELECT concat(ps.first_name, ' ', ps.last_name) AS "Fullname",
       s.email AS "Email",
       cs.topic AS "Topic",
       cs.message AS "Message",
       cs.status AS "Status",
       cs.date AS "Date"
FROM student s
JOIN profile_student ps ON ps.student_id = s.id
JOIN course_suggestion cs ON cs.student_id = s.id
ORDER BY CASE cs.status
  WHEN 'New' THEN 1
  WHEN 'Responded' THEN 2
  WHEN 'Declined' THEN 3
  ELSE 4
END;

-- Triggers
CREATE OR REPLACE FUNCTION trg_admin_after_insert()
RETURNS trigger
LANGUAGE plpgsql
AS $$
BEGIN
  INSERT INTO profile_admin(admin_id, first_name, last_name, address, phone_number, photo_profile)
  VALUES (NEW.id, NEW.username, '', '', '', '');
  RETURN NEW;
END;
$$;

DROP TRIGGER IF EXISTS admin_a_insert ON admin;
CREATE TRIGGER admin_a_insert
AFTER INSERT ON admin
FOR EACH ROW
EXECUTE FUNCTION trg_admin_after_insert();

CREATE OR REPLACE FUNCTION trg_student_after_insert()
RETURNS trigger
LANGUAGE plpgsql
AS $$
BEGIN
  INSERT INTO profile_student(student_id, first_name, last_name, address, phone_number)
  VALUES (NEW.id, NEW.username, '', '', '');
  RETURN NEW;
END;
$$;

DROP TRIGGER IF EXISTS student_a_insert ON student;
CREATE TRIGGER student_a_insert
AFTER INSERT ON student
FOR EACH ROW
EXECUTE FUNCTION trg_student_after_insert();

commit;
